name: CI – Frappe Tests

on:
  pull_request:
    types: [opened, reopened, synchronize, ready_for_review]
  push:
    branches: [ main, development ,"dev_abhirock" ]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: "3.11"
  NODE_VERSION: "22"
  APP_NAME: "frappe_theme"
  SITE_NAME: "test.localhost"
  FRAPPE_BRANCH: "develop"
  DB_HOST: "127.0.0.1"
  DB_ROOT_USER: "root"
  DB_ROOT_PASSWORD: "root"

jobs:
  frappe-tests:
    name: Frappe unit tests
    runs-on: ubuntu-latest
    services:
      mariadb:
        image: mariadb:10.6
        env:
          MARIADB_ROOT_PASSWORD: root
          MARIADB_DATABASE: testdb
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -h 127.0.0.1 -proot || exit 1"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=10
      redis:
        image: redis:6-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install system dependencies
        run: |
          echo "Installing system dependencies..."
          sudo apt-get update
          sudo apt-get install -y build-essential python3-dev libffi-dev libssl-dev libmysqlclient-dev
          echo "✓ System dependencies installed"

      - name: Install bench and helpers
        run: |
          echo "Installing frappe-bench and utilities..."
          python -m pip install --upgrade pip
          pip install "frappe-bench>=5" pre-commit
          echo "✓ Bench installed successfully"

      - name: Initialize bench (Frappe)
        run: |
          echo "Initializing Frappe bench with branch: ${{ env.FRAPPE_BRANCH }}"
          bench init --frappe-branch "${{ env.FRAPPE_BRANCH }}" --skip-assets --skip-redis-config-generation --python "python${{ env.PYTHON_VERSION }}" ci-bench
          echo "✓ Bench initialized successfully"

      - name: Configure esbuild target globally
        working-directory: ci-bench
        run: |
          echo "Setting esbuild target to es2022 for modern JS support..."
          bench set-config -g esbuild_target "es2022"
          echo "✓ esbuild_target configured"

      - name: Add app to bench
        working-directory: ci-bench
        run: |
          echo "Adding ${{ env.APP_NAME }} to bench..."
          bench get-app --no-cache "${{ github.workspace }}" || bench get-app "${{ github.workspace }}"
          echo "✓ App added successfully"

      - name: Configure Redis hosts in bench
        working-directory: ci-bench
        run: |
          echo "Configuring Redis connections..."
          bench set-config -g redis_cache   redis://127.0.0.1:6379
          bench set-config -g redis_queue   redis://127.0.0.1:6379
          bench set-config -g redis_socketio redis://127.0.0.1:6379
          echo "✓ Redis configured"

      - name: Create site
        working-directory: ci-bench
        env:
          SITE_NAME: ${{ env.SITE_NAME }}
          DB_HOST: ${{ env.DB_HOST }}
          DB_ROOT_USER: ${{ env.DB_ROOT_USER }}
          DB_ROOT_PASSWORD: ${{ env.DB_ROOT_PASSWORD }}
        run: |
          echo "Creating new site: $SITE_NAME..."
          bench new-site "$SITE_NAME" \
            --db-host "$DB_HOST" \
            --mariadb-root-username "$DB_ROOT_USER" \
            --mariadb-root-password "$DB_ROOT_PASSWORD" \
            --mariadb-user-host-login-scope "%" \
            --admin-password admin \
            --verbose
          echo "✓ Site created successfully"

      - name: Install app into site
        working-directory: ci-bench
        env:
          SITE_NAME: ${{ env.SITE_NAME }}
          APP_NAME: ${{ env.APP_NAME }}
        run: |
          echo "Installing $APP_NAME into site $SITE_NAME..."
          bench --site "$SITE_NAME" install-app "$APP_NAME"
          echo "✓ App installed successfully"

      - name: Build and validate frontend assets
        working-directory: ci-bench
        env:
          APP_NAME: ${{ env.APP_NAME }}
        run: |
          echo "=================================================="
          echo "Building frontend assets for $APP_NAME..."
          echo "=================================================="
          bench build --app "$APP_NAME" --verbose

      - name: Run Frappe tests for app
        working-directory: ci-bench
        env:
          SITE_NAME: ${{ env.SITE_NAME }}
          APP_NAME: ${{ env.APP_NAME }}
        run: |
          echo "=================================================="
          echo "Running test suite for $APP_NAME on site $SITE_NAME..."
          echo "=================================================="
          bench --site "$SITE_NAME" run-tests --app "$APP_NAME" --profile
