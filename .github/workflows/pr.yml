name: CI â€“ pre-commit and Frappe tests

on:
  # Run on all PRs (any target branch) and on pushes to main/development (typically after merge)
  pull_request:
    types: [opened, reopened, synchronize, ready_for_review]
  push:
    branches: [ main, development ,"dev_abhirock" ]

env:
  PYTHON_VERSION: "3.11"
  NODE_VERSION: "18"
  APP_NAME: "frappe_theme"
  SITE_NAME: "test.localhost"
  FRAPPE_BRANCH: "version-14" # Adjust to your target Frappe branch (e.g., version-15)
  DB_HOST: "mariadb"
  DB_ROOT_USER: "root"
  DB_ROOT_PASSWORD: "root"

jobs:
  pre-commit:
    name: pre-commit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pre-commit
        uses: actions/cache@v4
        with:
          path: ~/.cache/pre-commit
          key: pre-commit-${{ runner.os }}-${{ env.PYTHON_VERSION }}-${{ hashFiles('.pre-commit-config.yaml') }}

      - name: Install pre-commit
        run: |
          python -m pip install --upgrade pip
          pip install pre-commit

      - name: Run pre-commit
        run: |
          pre-commit --version
          pre-commit run --all-files --show-diff-on-failure --color always

  frappe-tests:
    name: Frappe unit tests
    runs-on: ubuntu-latest
    needs: pre-commit
    services:
      mariadb:
        image: mariadb:10.6
        env:
          MARIADB_ROOT_PASSWORD: ${{ env.DB_ROOT_PASSWORD }}
          MARIADB_DATABASE: testdb
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -h 127.0.0.1 -p${{ env.DB_ROOT_PASSWORD }} || exit 1"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=10
      redis:
        image: redis:6-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential python3-dev libffi-dev libssl-dev libmysqlclient-dev

      - name: Install bench and helpers
        run: |
          python -m pip install --upgrade pip
          pip install "frappe-bench>=5" pre-commit

      - name: Initialize bench (Frappe)
        run: |
          bench init --frappe-branch "${{ env.FRAPPE_BRANCH }}" --skip-assets --skip-redis-config-generation --python "python${{ env.PYTHON_VERSION }}" ci-bench

      - name: Add app to bench
        working-directory: ci-bench
        run: |
          # The bench created frappe already; bring our app from the checked-out workspace
          bench get-app --no-cache "${{ github.workspace }}" || bench get-app "${{ github.workspace }}"

      - name: Configure Redis hosts in bench
        working-directory: ci-bench
        run: |
          bench set-config -g redis_cache   redis://redis:6379
          bench set-config -g redis_queue   redis://redis:6379
          bench set-config -g redis_socketio redis://redis:6379

      - name: Create site
        working-directory: ci-bench
        env:
          SITE_NAME: ${{ env.SITE_NAME }}
          DB_HOST: ${{ env.DB_HOST }}
          DB_ROOT_USER: ${{ env.DB_ROOT_USER }}
          DB_ROOT_PASSWORD: ${{ env.DB_ROOT_PASSWORD }}
        run: |
          bench new-site "$SITE_NAME" \
            --db-host "$DB_HOST" \
            --mariadb-root-username "$DB_ROOT_USER" \
            --mariadb-root-password "$DB_ROOT_PASSWORD" \
            --admin-password admin \
            --no-mariadb-socket \
            --verbose

      - name: Install app into site
        working-directory: ci-bench
        env:
          SITE_NAME: ${{ env.SITE_NAME }}
          APP_NAME: ${{ env.APP_NAME }}
        run: |
          bench --site "$SITE_NAME" install-app "$APP_NAME"

      - name: Run Frappe tests for app
        working-directory: ci-bench
        env:
          SITE_NAME: ${{ env.SITE_NAME }}
          APP_NAME: ${{ env.APP_NAME }}
        run: |
          # Run the app's test suite via Frappe's runner
          bench --site "$SITE_NAME" run-tests --app "$APP_NAME" --profile
