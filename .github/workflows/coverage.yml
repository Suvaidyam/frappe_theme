name: Code Coverage

on:
  pull_request:
    types: [opened, reopened, synchronize]
  push:
    branches: [ main, development ]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: "3.11"
  NODE_VERSION: "22"
  APP_NAME: "frappe_theme"
  SITE_NAME: "coverage.localhost"
  FRAPPE_BRANCH: "develop"
  DB_HOST: "127.0.0.1"
  DB_ROOT_USER: "root"
  DB_ROOT_PASSWORD: "root"

jobs:
  coverage:
    name: Test Coverage Report
    runs-on: ubuntu-latest
    
    services:
      mariadb:
        image: mariadb:10.6
        env:
          MARIADB_ROOT_PASSWORD: root
          MARIADB_DATABASE: testdb
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -h 127.0.0.1 -proot || exit 1"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=10
      
      redis:
        image: redis:6-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install system dependencies
        run: |
          echo "Installing system dependencies..."
          sudo apt-get update
          sudo apt-get install -y build-essential python3-dev libffi-dev libssl-dev libmysqlclient-dev
          echo "âœ“ System dependencies installed"

      - name: Install bench and coverage tools
        run: |
          echo "Installing frappe-bench and coverage utilities..."
          python -m pip install --upgrade pip
          pip install "frappe-bench>=5" coverage pytest-cov
          echo "âœ“ Bench and coverage tools installed"

      - name: Initialize bench
        run: |
          echo "Initializing Frappe bench with branch: ${{ env.FRAPPE_BRANCH }}"
          bench init --frappe-branch "${{ env.FRAPPE_BRANCH }}" --skip-assets --skip-redis-config-generation --python "python${{ env.PYTHON_VERSION }}" coverage-bench
          echo "âœ“ Bench initialized"

      - name: Configure esbuild target
        working-directory: coverage-bench
        run: |
          bench set-config -g esbuild_target "es2022"
          echo "âœ“ esbuild_target configured"

      - name: Add app to bench
        working-directory: coverage-bench
        run: |
          echo "Adding ${{ env.APP_NAME }} to bench..."
          bench get-app --no-cache "${{ github.workspace }}" || bench get-app "${{ github.workspace }}"
          echo "âœ“ App added"

      - name: Configure Redis
        working-directory: coverage-bench
        run: |
          bench set-config -g redis_cache   redis://127.0.0.1:6379
          bench set-config -g redis_queue   redis://127.0.0.1:6379
          bench set-config -g redis_socketio redis://127.0.0.1:6379
          echo "âœ“ Redis configured"

      - name: Create site
        working-directory: coverage-bench
        run: |
          echo "Creating site: ${{ env.SITE_NAME }}..."
          bench new-site "${{ env.SITE_NAME }}" \
            --db-host "${{ env.DB_HOST }}" \
            --mariadb-root-username "${{ env.DB_ROOT_USER }}" \
            --mariadb-root-password "${{ env.DB_ROOT_PASSWORD }}" \
            --mariadb-user-host-login-scope "%" \
            --admin-password admin \
            --verbose
          echo "âœ“ Site created"

      - name: Install app on site
        working-directory: coverage-bench
        run: |
          bench --site "${{ env.SITE_NAME }}" install-app "${{ env.APP_NAME }}"
          echo "âœ“ App installed"

      - name: Run tests with coverage
        working-directory: coverage-bench
        run: |
          echo "=================================================="
          echo "Running tests with coverage tracking..."
          echo "=================================================="
          bench --site "${{ env.SITE_NAME }}" run-tests \
            --app "${{ env.APP_NAME }}" \
            --coverage \
            --profile
          echo "âœ“ Tests completed with coverage"

      - name: Generate coverage report
        working-directory: coverage-bench
        run: |
          echo "Generating coverage reports..."
          
          # Find the coverage data file
          COVERAGE_FILE=$(find . -name ".coverage*" -type f | head -n 1)
          
          if [ -n "$COVERAGE_FILE" ]; then
            echo "Found coverage file: $COVERAGE_FILE"
            
            # Generate text report
            coverage report --data-file="$COVERAGE_FILE" > coverage-report.txt || true
            
            # Generate XML report for tools
            coverage xml --data-file="$COVERAGE_FILE" -o coverage.xml || true
            
            # Generate HTML report
            coverage html --data-file="$COVERAGE_FILE" -d htmlcov || true
            
            # Display summary in console
            echo "=================================================="
            echo "COVERAGE SUMMARY"
            echo "=================================================="
            coverage report --data-file="$COVERAGE_FILE" || true
          else
            echo "âš ï¸  No coverage data found"
            echo "Coverage may not have been generated properly"
          fi

      - name: Upload coverage reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-reports
          path: |
            coverage-bench/coverage.xml
            coverage-bench/coverage-report.txt
            coverage-bench/htmlcov/
          retention-days: 30

      - name: Comment coverage on PR
        if: github.event_name == 'pull_request'
        continue-on-error: true
        run: |
          if [ -f coverage-bench/coverage-report.txt ]; then
            echo "ðŸ“Š **Code Coverage Report**" > coverage-comment.md
            echo "" >> coverage-comment.md
            echo "\`\`\`" >> coverage-comment.md
            head -n 50 coverage-bench/coverage-report.txt >> coverage-comment.md
            echo "\`\`\`" >> coverage-comment.md
            echo "" >> coverage-comment.md
            echo "ðŸ“¥ Full coverage reports available in workflow artifacts" >> coverage-comment.md
            
            # Display the comment content in the workflow logs
            cat coverage-comment.md
          fi

      - name: Check coverage threshold
        working-directory: coverage-bench
        continue-on-error: true
        run: |
          echo "Checking coverage threshold (minimum 70%)..."
          COVERAGE_FILE=$(find . -name ".coverage*" -type f | head -n 1)
          
          if [ -n "$COVERAGE_FILE" ]; then
            # Extract coverage percentage
            COVERAGE_PCT=$(coverage report --data-file="$COVERAGE_FILE" | grep TOTAL | awk '{print $4}' | sed 's/%//')
            
            echo "Total coverage: ${COVERAGE_PCT}%"
            
            if [ -n "$COVERAGE_PCT" ] && [ $(echo "$COVERAGE_PCT < 70" | bc -l) -eq 1 ]; then
              echo "âš ï¸  Coverage is below 70% threshold"
              echo "::warning::Code coverage (${COVERAGE_PCT}%) is below the recommended 70% threshold"
            else
              echo "âœ“ Coverage meets or exceeds 70% threshold"
            fi
          fi

      - name: Generate coverage badge data
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        working-directory: coverage-bench
        continue-on-error: true
        run: |
          COVERAGE_FILE=$(find . -name ".coverage*" -type f | head -n 1)
          
          if [ -n "$COVERAGE_FILE" ]; then
            COVERAGE_PCT=$(coverage report --data-file="$COVERAGE_FILE" | grep TOTAL | awk '{print $4}' | sed 's/%//')
            
            if [ -n "$COVERAGE_PCT" ]; then
              echo "COVERAGE_PERCENTAGE=$COVERAGE_PCT" >> $GITHUB_ENV
              echo "Coverage percentage for badge: ${COVERAGE_PCT}%"
            fi
          fi
